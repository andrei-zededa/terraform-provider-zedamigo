{"author":{"id":"2ccea35425168fbab72988d9e45ab8fb60181ab0c3792f0d9ed35f219a8ebf7a"},"ops":[{"type":1,"timestamp":1753961411,"nonce":"2HZaW1/KhjI9Ci+pxMFgMwibh18=","title":"Provider crash on `destroy` when QEMU VMs are NOTE running","message":"```\n‚àëzedcloud.gmwtus.zededa.net üî®gmwtus-bis ev-zed1 @ mutriku in ‚Ä¶/cases/2998/TF\n‚ùØ tf state ls\nzedamigo_bridge.BRIDGE_AAAA\nzedamigo_bridge.BRIDGE_BBBB\nzedamigo_disk_image.empty_disk_200G\nzedamigo_edge_node.ENODE_1207_VM\nzedamigo_edge_node.ENODE_1450_VM\nzedamigo_eve_installer.eve1207lts\nzedamigo_eve_installer.eve1450lts\nzedamigo_installed_edge_node.ENODE_1207_INSTALL\nzedamigo_installed_edge_node.ENODE_1450_INSTALL\nzedamigo_tap.TAP_101\nzedamigo_tap.TAP_102\nzedamigo_tap.TAP_201\nzedamigo_tap.TAP_202\n\n‚àëzedcloud.gmwtus.zededa.net üî®gmwtus-bis ev-zed1 @ mutriku in ‚Ä¶/cases/2998/TF\n‚ùØ tfdestroy -exclude=zedamigo_bridge.BRIDGE_AAAA -exclude=zedamigo_bridge.BRIDGE_BBBB\n‚ï∑\n‚îÇ Warning: Provider development overrides are in effect\n‚îÇ\n‚îÇ The following provider development overrides are set in the CLI configuration:\n‚îÇ  - andrei-zededa/zedamigo in /home/ev-zed1/ZED/git/github.com/andrei-zededa/terraform-provider-zedamigo\n‚îÇ  - zededa/zedcloud in /home/ev-zed1/ZED/git/github.com/zededa/terraform-provider-zedcloud/v2\n‚îÇ\n‚îÇ The behavior may therefore not match any released version of the provider and applying changes may cause the state to become incompatible with published releases.\n‚ïµ\nzedamigo_disk_image.empty_disk_200G: Refreshing state... [id=bb72c2bb-444c-4ce2-a8e8-504a50cc7120]\nzedamigo_eve_installer.eve1450lts: Refreshing state... [id=4aa0aa80-4a55-4d99-bba4-378cbe91caf1]\nzedamigo_eve_installer.eve1207lts: Refreshing state... [id=c7a10e8f-2595-45c8-a862-ddea6dd177dc]\nzedamigo_installed_edge_node.ENODE_1207_INSTALL: Refreshing state... [id=d2ec89f6-23dd-4834-ae79-4f6c474fb984]\nzedamigo_installed_edge_node.ENODE_1450_INSTALL: Refreshing state... [id=abc2b628-89fc-409e-a0e6-8abc588ebcf2]\n\nOpenTofu used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:\n  - destroy\n\nOpenTofu will perform the following actions:\n\n  # zedamigo_disk_image.empty_disk_200G will be destroyed\n  - resource \"zedamigo_disk_image\" \"empty_disk_200G\" {\n      - filename   = \"/home/ev-zed1/.local/state/zedamigo/disk_images/bb72c2bb-444c-4ce2-a8e8-504a50cc7120/empty_disk_200G.disk_img.qcow2\" -\u003e null\n      - id         = \"bb72c2bb-444c-4ce2-a8e8-504a50cc7120\" -\u003e null\n      - name       = \"empty_disk_200G\" -\u003e null\n      - size_mb    = 200000 -\u003e null\n      - used_bytes = 16896 -\u003e null\n    }\n\n  # zedamigo_edge_node.ENODE_1207_VM will be destroyed\n  - resource \"zedamigo_edge_node\" \"ENODE_1207_VM\" {\n      - cpus               = \"4\" -\u003e null\n      - disk_image         = \"/home/ev-zed1/.local/state/zedamigo/edge_nodes/0f087ce3-d177-462b-8bb4-06ca9404ea7b/disk0.disk_img.qcow2\" -\u003e null\n      - disk_image_base    = \"/home/ev-zed1/.local/state/zedamigo/installed_nodes/d2ec89f6-23dd-4834-ae79-4f6c474fb984/disk0.disk_img.qcow2\" -\u003e null\n      - extra_qemu_args    = [\n          - \"-nic\",\n          - \"tap,id=usernet1,ifname=test-201,script=no,downscript=no,model=virtio\",\n          - \"-nic\",\n          - \"tap,id=usernet2,ifname=test-202,script=no,downscript=no,model=virtio\",\n        ] -\u003e null\n      - id                 = \"0f087ce3-d177-462b-8bb4-06ca9404ea7b\" -\u003e null\n      - mem                = \"4G\" -\u003e null\n      - name               = \"ENODE_1207_VM\" -\u003e null\n      - ovmf_vars          = \"/home/ev-zed1/.local/state/zedamigo/edge_nodes/0f087ce3-d177-462b-8bb4-06ca9404ea7b/UEFI_OVMF_VARS.bin\" -\u003e null\n      - ovmf_vars_src      = \"/home/ev-zed1/.local/state/zedamigo/installed_nodes/d2ec89f6-23dd-4834-ae79-4f6c474fb984/UEFI_OVMF_VARS.bin\" -\u003e null\n      - qmp_socket         = \"unix:/home/ev-zed1/.local/state/zedamigo/edge_nodes/0f087ce3-d177-462b-8bb4-06ca9404ea7b/qmp.socket,server,nowait\" -\u003e null\n      - serial_console_log = \"/home/ev-zed1/.local/state/zedamigo/edge_nodes/0f087ce3-d177-462b-8bb4-06ca9404ea7b/serial_console_run.log\" -\u003e null\n      - serial_no          = \"SN_1207_6982619\" -\u003e null\n      - serial_port_server = true -\u003e null\n      - serial_port_socket = \"/home/ev-zed1/.local/state/zedamigo/edge_nodes/0f087ce3-d177-462b-8bb4-06ca9404ea7b/serial_port.socket\" -\u003e null\n      - ssh_port           = 35539 -\u003e null\n      - vm_running         = true -\u003e null\n    }\n\n  # zedamigo_edge_node.ENODE_1450_VM will be destroyed\n  - resource \"zedamigo_edge_node\" \"ENODE_1450_VM\" {\n      - cpus               = \"4\" -\u003e null\n      - disk_image         = \"/home/ev-zed1/.local/state/zedamigo/edge_nodes/f3942ae6-3e7f-4e35-805c-97bd0eaedb06/disk0.disk_img.qcow2\" -\u003e null\n      - disk_image_base    = \"/home/ev-zed1/.local/state/zedamigo/installed_nodes/abc2b628-89fc-409e-a0e6-8abc588ebcf2/disk0.disk_img.qcow2\" -\u003e null\n      - extra_qemu_args    = [\n          - \"-nic\",\n          - \"tap,id=usernet1,ifname=test-101,script=no,downscript=no,model=virtio\",\n          - \"-nic\",\n          - \"tap,id=usernet2,ifname=test-102,script=no,downscript=no,model=virtio\",\n        ] -\u003e null\n      - id                 = \"f3942ae6-3e7f-4e35-805c-97bd0eaedb06\" -\u003e null\n      - mem                = \"4G\" -\u003e null\n      - name               = \"ENODE_1450_VM\" -\u003e null\n      - ovmf_vars          = \"/home/ev-zed1/.local/state/zedamigo/edge_nodes/f3942ae6-3e7f-4e35-805c-97bd0eaedb06/UEFI_OVMF_VARS.bin\" -\u003e null\n      - ovmf_vars_src      = \"/home/ev-zed1/.local/state/zedamigo/installed_nodes/abc2b628-89fc-409e-a0e6-8abc588ebcf2/UEFI_OVMF_VARS.bin\" -\u003e null\n      - qmp_socket         = \"unix:/home/ev-zed1/.local/state/zedamigo/edge_nodes/f3942ae6-3e7f-4e35-805c-97bd0eaedb06/qmp.socket,server,nowait\" -\u003e null\n      - serial_console_log = \"/home/ev-zed1/.local/state/zedamigo/edge_nodes/f3942ae6-3e7f-4e35-805c-97bd0eaedb06/serial_console_run.log\" -\u003e null\n      - serial_no          = \"SN_1450_6982619\" -\u003e null\n      - serial_port_server = true -\u003e null\n      - serial_port_socket = \"/home/ev-zed1/.local/state/zedamigo/edge_nodes/f3942ae6-3e7f-4e35-805c-97bd0eaedb06/serial_port.socket\" -\u003e null\n      - ssh_port           = 46597 -\u003e null\n      - vm_running         = true -\u003e null\n    }\n\n  # zedamigo_eve_installer.eve1207lts will be destroyed\n  - resource \"zedamigo_eve_installer\" \"eve1207lts\" {\n      - authorized_keys = (sensitive value) -\u003e null\n      - cluster         = \"zedcloud.gmwtus.zededa.net\" -\u003e null\n      - filename        = \"/home/ev-zed1/.local/state/zedamigo/eve_installers/c7a10e8f-2595-45c8-a862-ddea6dd177dc/eve1207lts.custom_installer.iso\" -\u003e null\n      - id              = \"c7a10e8f-2595-45c8-a862-ddea6dd177dc\" -\u003e null\n      - name            = \"eve1207lts\" -\u003e null\n      - tag             = \"12.0.7-lts-kvm-amd64\" -\u003e null\n    }\n\n  # zedamigo_eve_installer.eve1450lts will be destroyed\n  - resource \"zedamigo_eve_installer\" \"eve1450lts\" {\n      - authorized_keys = (sensitive value) -\u003e null\n      - cluster         = \"zedcloud.gmwtus.zededa.net\" -\u003e null\n      - filename        = \"/home/ev-zed1/.local/state/zedamigo/eve_installers/4aa0aa80-4a55-4d99-bba4-378cbe91caf1/eve1450lts.custom_installer.iso\" -\u003e null\n      - id              = \"4aa0aa80-4a55-4d99-bba4-378cbe91caf1\" -\u003e null\n      - name            = \"eve1450lts\" -\u003e null\n      - tag             = \"14.5.0-lts-kvm-amd64\" -\u003e null\n    }\n\n  # zedamigo_installed_edge_node.ENODE_1207_INSTALL will be destroyed\n  - resource \"zedamigo_installed_edge_node\" \"ENODE_1207_INSTALL\" {\n      - disk_image         = \"/home/ev-zed1/.local/state/zedamigo/installed_nodes/d2ec89f6-23dd-4834-ae79-4f6c474fb984/disk0.disk_img.qcow2\" -\u003e null\n      - disk_image_base    = \"/home/ev-zed1/.local/state/zedamigo/disk_images/bb72c2bb-444c-4ce2-a8e8-504a50cc7120/empty_disk_200G.disk_img.qcow2\" -\u003e null\n      - id                 = \"d2ec89f6-23dd-4834-ae79-4f6c474fb984\" -\u003e null\n      - installer_iso      = \"/home/ev-zed1/.local/state/zedamigo/eve_installers/c7a10e8f-2595-45c8-a862-ddea6dd177dc/eve1207lts.custom_installer.iso\" -\u003e null\n      - name               = \"ENODE_1207_INSTALL\" -\u003e null\n      - ovmf_vars          = \"/home/ev-zed1/.local/state/zedamigo/installed_nodes/d2ec89f6-23dd-4834-ae79-4f6c474fb984/UEFI_OVMF_VARS.bin\" -\u003e null\n      - serial_console_log = \"/home/ev-zed1/.local/state/zedamigo/installed_nodes/d2ec89f6-23dd-4834-ae79-4f6c474fb984/serial_console_install.log\" -\u003e null\n      - serial_no          = \"SN_1207_6982619\" -\u003e null\n      - success            = true -\u003e null\n    }\n\n  # zedamigo_installed_edge_node.ENODE_1450_INSTALL will be destroyed\n  - resource \"zedamigo_installed_edge_node\" \"ENODE_1450_INSTALL\" {\n      - disk_image         = \"/home/ev-zed1/.local/state/zedamigo/installed_nodes/abc2b628-89fc-409e-a0e6-8abc588ebcf2/disk0.disk_img.qcow2\" -\u003e null\n      - disk_image_base    = \"/home/ev-zed1/.local/state/zedamigo/disk_images/bb72c2bb-444c-4ce2-a8e8-504a50cc7120/empty_disk_200G.disk_img.qcow2\" -\u003e null\n      - id                 = \"abc2b628-89fc-409e-a0e6-8abc588ebcf2\" -\u003e null\n      - installer_iso      = \"/home/ev-zed1/.local/state/zedamigo/eve_installers/4aa0aa80-4a55-4d99-bba4-378cbe91caf1/eve1450lts.custom_installer.iso\" -\u003e null\n      - name               = \"ENODE_1450_INSTALL\" -\u003e null\n      - ovmf_vars          = \"/home/ev-zed1/.local/state/zedamigo/installed_nodes/abc2b628-89fc-409e-a0e6-8abc588ebcf2/UEFI_OVMF_VARS.bin\" -\u003e null\n      - serial_console_log = \"/home/ev-zed1/.local/state/zedamigo/installed_nodes/abc2b628-89fc-409e-a0e6-8abc588ebcf2/serial_console_install.log\" -\u003e null\n      - serial_no          = \"SN_1450_6982619\" -\u003e null\n      - success            = true -\u003e null\n    }\n\n  # zedamigo_tap.TAP_101 will be destroyed\n  - resource \"zedamigo_tap\" \"TAP_101\" {\n      - group  = \"kvm\" -\u003e null\n      - id     = \"9838ff26-7ede-4ab3-a784-7a15cff4af9e\" -\u003e null\n      - master = \"test-br-aaaa\" -\u003e null\n      - mtu    = 1500 -\u003e null\n      - name   = \"test-101\" -\u003e null\n      - state  = \"up\" -\u003e null\n    }\n\n  # zedamigo_tap.TAP_102 will be destroyed\n  - resource \"zedamigo_tap\" \"TAP_102\" {\n      - group  = \"kvm\" -\u003e null\n      - id     = \"9c393578-ab9d-41ab-af27-120b92e528a2\" -\u003e null\n      - master = \"test-br-bbbb\" -\u003e null\n      - mtu    = 1500 -\u003e null\n      - name   = \"test-102\" -\u003e null\n      - state  = \"up\" -\u003e null\n    }\n\n  # zedamigo_tap.TAP_201 will be destroyed\n  - resource \"zedamigo_tap\" \"TAP_201\" {\n      - group  = \"kvm\" -\u003e null\n      - id     = \"55048eeb-a36e-42df-abc5-fc7d88b8ff71\" -\u003e null\n      - master = \"test-br-aaaa\" -\u003e null\n      - mtu    = 1500 -\u003e null\n      - name   = \"test-201\" -\u003e null\n      - state  = \"up\" -\u003e null\n    }\n\n  # zedamigo_tap.TAP_202 will be destroyed\n  - resource \"zedamigo_tap\" \"TAP_202\" {\n      - group  = \"kvm\" -\u003e null\n      - id     = \"fc12b461-1006-408a-8757-c542d37ac9b9\" -\u003e null\n      - master = \"test-br-bbbb\" -\u003e null\n      - mtu    = 1500 -\u003e null\n      - name   = \"test-202\" -\u003e null\n      - state  = \"up\" -\u003e null\n    }\n\nPlan: 0 to add, 0 to change, 11 to destroy.\nzedamigo_edge_node.ENODE_1450_VM: Destroying... [id=f3942ae6-3e7f-4e35-805c-97bd0eaedb06]\nzedamigo_edge_node.ENODE_1207_VM: Destroying... [id=0f087ce3-d177-462b-8bb4-06ca9404ea7b]\n‚ï∑\n‚îÇ Warning: Resource targeting is in effect\n‚îÇ\n‚îÇ You are creating a plan with either the -target option or the -exclude option, which means that the result of this plan may not represent all of the changes requested by the current\n‚îÇ configuration.\n‚îÇ\n‚îÇ The -target and -exclude options are not for routine use, and are provided only for exceptional situations such as recovering from errors or mistakes, or when OpenTofu specifically suggests to\n‚îÇ use it as part of an error message.\n‚ïµ\n‚ï∑\n‚îÇ Warning: Applied changes may be incomplete\n‚îÇ\n‚îÇ The plan was created with the -target or the -exclude option in effect, so some changes requested in the configuration may have been ignored and the output values may not be fully updated. Run\n‚îÇ the following command to verify that no other changes are pending:\n‚îÇ     tofu plan\n‚îÇ \t\n‚îÇ Note that the -target and -exclude options are not suitable for routine use, and are provided only for exceptional situations such as recovering from errors or mistakes, or when OpenTofu\n‚îÇ specifically suggests to use it as part of an error message.\n‚ïµ\n‚ï∑\n‚îÇ Error: Plugin did not respond\n‚îÇ\n‚îÇ The plugin encountered an error, and failed to respond to the plugin6.(*GRPCProvider).ApplyResourceChange call. The plugin logs may contain more details.\n‚ïµ\n‚ï∑\n‚îÇ Error: Plugin did not respond\n‚îÇ\n‚îÇ The plugin encountered an error, and failed to respond to the plugin6.(*GRPCProvider).ApplyResourceChange call. The plugin logs may contain more details.\n‚ïµ\n\nStack trace from the terraform-provider-zedamigo plugin:\n\npanic: runtime error: invalid memory address or nil pointer dereference\n[signal SIGSEGV: segmentation violation code=0x1 addr=0x20 pc=0x6e6d62]\n\ngoroutine 24 [running]:\ngithub.com/andrei-zededa/terraform-provider-zedamigo/internal/qmp.(*SocketMonitor).Connect(0x0)\n\t/home/ev-zed1/ZED/git/github.com/andrei-zededa/terraform-provider-zedamigo/internal/qmp/socket.go:123 +0x22\ngithub.com/andrei-zededa/terraform-provider-zedamigo/internal/provider.(*EdgeNode).Delete(0xc000418090, {0xe8da30, 0xc00033a750}, {{{{0xe93730, 0xc00034b5c0}, {0xc56660, 0xc00034acc0}}, {0xe95898, 0xc0001709b0}}, {{{0x0, ...}, ...}, ...}, ...}, ...)\n\t/home/ev-zed1/ZED/git/github.com/andrei-zededa/terraform-provider-zedamigo/internal/provider/edge_node_resource.go:504 +0x366\ngithub.com/hashicorp/terraform-plugin-framework/internal/fwserver.(*Server).DeleteResource(0xc00031a488, {0xe8da30, 0xc00033a750}, 0xc00006b4a0, 0xc00006b478)\n\t/home/ev-zed1/.go/pkg/mod/github.com/hashicorp/terraform-plugin-framework@v1.14.1/internal/fwserver/server_deleteresource.go:100 +0x5ee\ngithub.com/hashicorp/terraform-plugin-framework/internal/fwserver.(*Server).ApplyResourceChange(0xc00031a488, {0xe8da30, 0xc00033a750}, 0xc00042caf0, 0xc00006b5f0)\n\t/home/ev-zed1/.go/pkg/mod/github.com/hashicorp/terraform-plugin-framework@v1.14.1/internal/fwserver/server_applyresourcechange.go:79 +0x313\ngithub.com/hashicorp/terraform-plugin-framework/internal/proto6server.(*Server).ApplyResourceChange(0xc00031a488, {0xe8da30?, 0xc00033a660?}, 0xc00042ca50)\n\t/home/ev-zed1/.go/pkg/mod/github.com/hashicorp/terraform-plugin-framework@v1.14.1/internal/proto6server/server_applyresourcechange.go:55 +0x385\ngithub.com/hashicorp/terraform-plugin-go/tfprotov6/tf6server.(*server).ApplyResourceChange(0xc000232a00, {0xe8da30?, 0xc0000dfb30?}, 0xc0004da070)\n\t/home/ev-zed1/.go/pkg/mod/github.com/hashicorp/terraform-plugin-go@v0.26.0/tfprotov6/tf6server/server.go:866 +0x3b9\ngithub.com/hashicorp/terraform-plugin-go/tfprotov6/internal/tfplugin6._Provider_ApplyResourceChange_Handler({0xd37ca0, 0xc000232a00}, {0xe8da30, 0xc0000dfb30}, 0xc000072500, 0x0)\n\t/home/ev-zed1/.go/pkg/mod/github.com/hashicorp/terraform-plugin-go@v0.26.0/tfprotov6/internal/tfplugin6/tfplugin6_grpc.pb.go:611 +0x1a6\ngoogle.golang.org/grpc.(*Server).processUnaryRPC(0xc0001f2600, {0xe8da30, 0xc0000dfad0}, 0xc0000d25a0, 0xc00031d0b0, 0x14775d8, 0x0)\n\t/home/ev-zed1/.go/pkg/mod/google.golang.org/grpc@v1.69.4/server.go:1392 +0xfbe\ngoogle.golang.org/grpc.(*Server).handleStream(0xc0001f2600, {0xe8e588, 0xc0004f4000}, 0xc0000d25a0)\n\t/home/ev-zed1/.go/pkg/mod/google.golang.org/grpc@v1.69.4/server.go:1802 +0xb88\ngoogle.golang.org/grpc.(*Server).serveStreams.func2.1()\n\t/home/ev-zed1/.go/pkg/mod/google.golang.org/grpc@v1.69.4/server.go:1030 +0x7f\ncreated by google.golang.org/grpc.(*Server).serveStreams.func2 in goroutine 52\n\t/home/ev-zed1/.go/pkg/mod/google.golang.org/grpc@v1.69.4/server.go:1041 +0x11d\n\nError: The terraform-provider-zedamigo plugin crashed!\n\nThis is always indicative of a bug within the plugin. It would be immensely\nhelpful if you could report the crash with the plugin's maintainers so that it\ncan be fixed. The output above should help diagnose the issue.\n```","files":null}]}